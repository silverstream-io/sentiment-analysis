"use strict";(self.webpackChunksentiment_checker_zendesk_app=self.webpackChunksentiment_checker_zendesk_app||[]).push([[792],{86:(e,t,n)=>{n.r(t),n.d(t,{BackgroundApp:()=>a});var s=n(43),r=n(304);const a=e=>{let{zafClient:t,originalQueryString:n}=e;return(0,s.useEffect)((()=>{console.log("[BackgroundApp] useEffect triggered");const e=async e=>{console.log("[BackgroundApp] Ticket saved event received:",e);try{const n=await t.request({url:`/api/v2/search.json?query=id:${e.id}`,type:"GET"});if(n&&n.results&&n.results.length>0){const e=n.results[0],s={id:e.id,state:e.status,created_at:e.created_at,updated_at:e.updated_at};console.log("[BackgroundApp] Sending ticket data:",s),await(0,r.DF)(t,s)}else console.error("[BackgroundApp] Could not find ticket details")}catch(n){console.error("[BackgroundApp] Error in background refresh:",n)}};return console.log("[BackgroundApp] Adding ticket.saved event listener"),t.on("ticket.saved",e),()=>{console.log("[BackgroundApp] Removing ticket.saved event listener"),t.off("ticket.saved",e)}}),[t]),null}},977:(e,t,n)=>{n.r(t),n.d(t,{MainApp:()=>d});var s=n(43),r=n(304),a=n(341),i=n(579);const c=e=>{let{zafClient:t,onSentimentUpdate:n}=e;const[c,o]=(0,s.useState)(null),[l,d]=(0,s.useState)(!1),[u,h]=(0,s.useState)(null);(0,s.useEffect)((()=>{!async function(){try{if(!t)throw new Error("ZAFClient is not initialized");d(!0);const e=(await t.get("ticket.id"))["ticket.id"];(0,r.cY)("Analyzing sentiment for ticket:",e);const s=await t.get("ticket.comments");if(0===s["ticket.comments"].length)return(0,r.cY)("No comments found for ticket:",e),"No comments found, check back later.";(0,r.cY)("ticketComments",s);const i=await t.request({url:`/api/v2/tickets/${e}/comments.json`,type:"GET"});if(!(i&&i.comments&&Array.isArray(i.comments)))throw(0,r.cY)("Unexpected structure in ticketDetails:",i),new Error("Unexpected structure in ticketDetails: "+JSON.stringify(i));{const e=new Map(i.comments.map((e=>[e.id,e.created_at])));s["ticket.comments"].forEach((t=>{e.has(t.id)&&(t.created_at=e.get(t.id))}))}const c=await(0,r.tp)(t,e);if((0,r.cY)("storedVectors",c),0===Object.keys(c).length)(0,r.cY)("No vectors found for ticket:",e),await(0,r.zH)(t,e,s);else{if(!Array.isArray(s["ticket.comments"]))throw(0,r.cY)("Unexpected structure in ticketComments:",s),new Error("Unexpected structure in ticketComments: "+JSON.stringify(s));{const n=s["ticket.comments"].filter((t=>!Object.values(c).some((n=>n.id===`${e}#${t.id}`))));n.length>0&&((0,r.cY)("Analyzing new comments:",n),await(0,r.zH)(t,e,{"ticket.comments":n}))}}const o=await(0,r.pB)(t,e),l=Math.max(a.bv,Math.min(a.FD,o));(0,r.cY)("Current ticket score:",l),n(e,l);const u=await(0,r.YB)(t),h=Math.max(a.bv,Math.min(a.FD,u));(0,r.cY)("Last 30 days score:",h),n(null,h),d(!1)}catch(c){console.error("Error analyzing sentiment:",c),o(c instanceof Error?c.message:"An unknown error occurred"),d(!1)}}()}),[t]);return c?(0,i.jsxs)("div",{children:["Error: ",c]}):l?(0,i.jsx)("div",{children:u}):null},o=e=>{let{sentiment:t,greyscale:n=!1}=e;const r=(0,s.useRef)(null),c=(0,s.useRef)(null);(0,s.useEffect)((()=>{if(r.current){const e=r.current,t=e.getContext("2d");t&&(e.width=200,e.height=120,o(t,e),l(t,e))}return()=>{null!==c.current&&cancelAnimationFrame(c.current)}}),[t]);const o=(e,t)=>{const s=t.width/2,r=t.height-10,a=Math.PI/5,i=n?["#333333","#666666","#999999","#CCCCCC","#FFFFFF"]:["red","orange","yellow","lightgreen","green"];for(let n=0;n<5;n++)e.beginPath(),e.moveTo(s,r),e.arc(s,r,90,Math.PI+n*a,Math.PI+(n+1)*a),e.closePath(),e.fillStyle=i[n],e.fill()},l=(e,n)=>{let s=null,r=180;const a=2e3,i=l=>{s||(s=l);const u=l-s;if(u<a)r=180-180*u/a;else{if(!(u<4e3&&null!==t))return;{const e=d(t);r=0+e*((u-a)/a)}}e.clearRect(0,0,n.width,n.height),o(e,n),((e,t,n)=>{const s=t.width/2,r=t.height-10,a=Math.PI*n/180;e.clearRect(0,0,t.width,t.height),o(e,t);const i=s+72*Math.cos(Math.PI+a),c=r+72*Math.sin(Math.PI+a);e.beginPath(),e.moveTo(s,r),e.lineTo(i,c),e.strokeStyle="black",e.lineWidth=2,e.stroke();const l=Math.PI+a;e.beginPath(),e.moveTo(i,c),e.lineTo(i-5*Math.cos(l-Math.PI/6),c-5*Math.sin(l-Math.PI/6)),e.lineTo(i-5*Math.cos(l+Math.PI/6),c-5*Math.sin(l+Math.PI/6)),e.closePath(),e.fillStyle="black",e.fill()})(e,n,r),c.current=requestAnimationFrame(i)};c.current=requestAnimationFrame(i)},d=e=>180*((e-a.bv)/(a.FD-a.bv));return(0,i.jsx)("div",{children:(0,i.jsx)("canvas",{ref:r,width:200,height:120,"aria-label":"Sentiment meter "+(null!==t?`showing ${t}`:"animating")})})};class l extends s.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("Error caught by boundary:",e,t)}render(){var e;return this.state.hasError?(0,i.jsxs)("div",{children:["Error: ",(null===(e=this.state.error)||void 0===e?void 0:e.message)||"Something went wrong"]}):this.props.children}}const d=e=>{let{zafClient:t,originalQueryString:n}=e;console.log("[App] Initializing with ZAF client");const[r,a]=(0,s.useState)(null),[d,u]=(0,s.useState)(null),[h,g]=(0,s.useState)(!1),[m]=(0,s.useState)(!1);(0,s.useEffect)((()=>{h&&t&&t.invoke("resize",{width:"100%",height:"600px"})}),[h,t]);return(0,i.jsx)(l,{children:(0,i.jsxs)("div",{className:"p-2",children:[(0,i.jsx)(c,{zafClient:t,onSentimentUpdate:(e,t)=>{console.log("[App] Sentiment update received:",{ticketId:e,sentiment:t}),null===e?u(t):a(t),g(!0)}}),h&&(0,i.jsxs)("div",{className:"flex flex-col space-y-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-base font-semibold mb-1",children:"Current Ticket"}),null!==r&&(0,i.jsx)(o,{sentiment:r,greyscale:m})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-base font-semibold mb-1",children:"Last 30 Days"}),null!==d&&(0,i.jsx)(o,{sentiment:d,greyscale:m})]})]})]})})}},94:(e,t,n)=>{n.r(t),n.d(t,{NavBarApp:()=>o});var s=n(43),r=n(304),a=n(535),i=n(579);const c=(e,t)=>{switch(t){case"sentiment":return e.score||0;case"created_at":return new Date(e.created_at).getTime();case"updated_at":return new Date(e.updated_at).getTime();default:return 0}},o=e=>{let{zafClient:t,originalQueryString:n,selectedRange:o}=e;const[l,d]=(0,s.useState)([]),[u,h]=(0,s.useState)(!0),[g,m]=(0,s.useState)(null),[p,v]=(0,s.useState)(1),[f,k]=(0,s.useState)(1),[y,x]=(0,s.useState)("sentiment"),[w,j]=(0,s.useState)("desc"),[S,b]=(0,s.useState)(""),[A,P]=(0,s.useState)(0),[C,M]=(0,s.useState)(0);(0,s.useEffect)((()=>{(async()=>{try{console.log("Starting fetchTickets..."),h(!0),console.log("Calling getUnsolvedTicketsFromCache...");const e=await(0,r.aM)(t);if(!e||!e.results)return d([]),void h(!1);const n=[...e.results];let s=n;if(n.length>0&&o&&(s=n.filter((e=>{var t;if(!e)return!1;const n=null!==(t=null===e||void 0===e?void 0:e.score)&&void 0!==t?t:0;switch(console.log("Ticket score:",n),o){case"negative":return n<=-.5;case"neutral":return n>-.5&&n<.5;case"positive":return n>=.5;default:return!0}})),console.log("Filtered tickets:",s)),s.length>0){console.log("Calculating stats...");const e=s.map((e=>{var t;return null!==(t=null===e||void 0===e?void 0:e.score)&&void 0!==t?t:0}));console.log("Scores:",e);const t=[...e].sort(((e,t)=>e-t)),n=Math.floor(t.length/2);P(t.length%2?t[n]:(t[n-1]+t[n])/2);const r=e.reduce(((e,t)=>e+t))/e.length,a=e.map((e=>Math.pow(e-r,2))),i=a.reduce(((e,t)=>e+t))/a.length;M(Math.sqrt(i)),console.log("Stats calculated - median:",A,"std:",C)}console.log("Sorting by:",y,w);const a=[...s].sort(((e,t)=>{const n=c(e,y),s=c(t,y);return console.log("Comparing:",n,s),"asc"===w?n>s?1:-1:n<s?1:-1})),i=25*(p-1),l=a.slice(i,i+25);k(Math.ceil(a.length/25));const u=await Promise.all(l.map((async e=>{try{const n=await t.request({url:`/api/v2/tickets/${e.id}.json`,type:"GET"});return console.log("Got details for ticket:",e.id),{...e,requestor:n.ticket.requester,assignee:n.ticket.assignee}}catch(g){return(0,r.PT)(`Error fetching details for ticket ${e.id}:`,g),e}})));console.log("All ticket details fetched:",u),d(u),h(!1)}catch(g){(0,r.PT)("Error fetching tickets:",g),m("Failed to load tickets"),h(!1)}})()}),[t,p,y,w,o]);const E=e=>{e===y?j((e=>"asc"===e?"desc":"asc")):(x(e),j("desc"))};return(0,i.jsxs)("div",{className:"navbar",children:[(0,i.jsx)("div",{className:"sentiment-bar",children:(0,i.jsxs)("div",{className:"gradient-bar",children:[(0,i.jsx)("div",{className:"median-line",style:{left:(A+1)/2*100+"%"}}),(0,i.jsx)("div",{className:"std-dev-box",style:{left:(A-C+1)/2*100+"%",width:C/2*100+"%"}})]})}),u?(0,i.jsx)("div",{className:"loading",children:"Loading tickets..."}):g?(0,i.jsx)("div",{className:"error",children:g}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("table",{className:"ticket-table",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsxs)("th",{onClick:()=>E("sentiment"),children:["Sentiment ","sentiment"===y&&("asc"===w?"\u2191":"\u2193")]}),(0,i.jsx)("th",{children:"Requestor"}),(0,i.jsx)("th",{children:"Assignee"}),(0,i.jsxs)("th",{onClick:()=>E("created_at"),children:["Created ","created_at"===y&&("asc"===w?"\u2191":"\u2193")]}),(0,i.jsxs)("th",{onClick:()=>E("updated_at"),children:["Updated ","updated_at"===y&&("asc"===w?"\u2191":"\u2193")]})]})}),(0,i.jsx)("tbody",{children:l.map((e=>{var n,s,r;return(0,i.jsxs)("tr",{onClick:()=>t.invoke("routeTo","ticket",e.id),children:[(0,i.jsx)("td",{children:(0,i.jsx)("div",{className:"sentiment-box",style:{backgroundColor:(r=e.score||0,r<=-.5?"#ffcccc":r>=.5?"#ccffcc":"#ffffcc")},children:(e.score||0).toFixed(2)})}),(0,i.jsx)("td",{children:(null===(n=e.requestor)||void 0===n?void 0:n.name)||"Unassigned"}),(0,i.jsx)("td",{children:(null===(s=e.assignee)||void 0===s?void 0:s.name)||"Unassigned"}),(0,i.jsx)("td",{children:(0,a.GP)(new Date(e.created_at),"MMM d, yyyy HH:mm")}),(0,i.jsx)("td",{children:(0,a.GP)(new Date(e.updated_at),"MMM d, yyyy HH:mm")})]},e.id)}))})]}),(0,i.jsxs)("div",{className:"pagination",children:[(0,i.jsx)("button",{onClick:()=>v((e=>Math.max(1,e-1))),disabled:1===p,children:"Previous"}),(0,i.jsxs)("span",{children:["Page ",p," of ",f]}),(0,i.jsx)("button",{onClick:()=>v((e=>Math.min(f,e+1))),disabled:p===f,children:"Next"})]})]})]})}},310:(e,t,n)=>{n.r(t),n.d(t,{TopbarApp:()=>i});var s=n(43),r=n(304),a=n(579);const i=e=>{let{zafClient:t,originalQueryString:n}=e;const[i,c]=(0,s.useState)({negative:0,neutral:0,positive:0}),[o,l]=(0,s.useState)(!0),d=async()=>{try{const e=await(0,r.aM)(t),n=((null===e||void 0===e?void 0:e.results)||[]).reduce(((e,t)=>{var n;const s=null!==(n=null===t||void 0===t?void 0:t.score)&&void 0!==n?n:0;return s<=-.5?e.negative++:s>=.5?e.positive++:e.neutral++,e}),{negative:0,neutral:0,positive:0});c(n),l(!1)}catch(e){(0,r.PT)("Error fetching counts:",e),l(!1)}};(0,s.useEffect)((()=>{d();const e=setInterval(d,6e4);return()=>clearInterval(e)}),[t]);const u=e=>{const s=new URLSearchParams(n);s.append("selected_range",e),t.invoke("nav_bar","show",{url:`assets/iframe.html?${s.toString()}`,active:!0})};return(0,a.jsxs)("div",{className:"topbar-counts",children:[(0,a.jsx)("div",{className:"count-box negative",onClick:()=>u("negative"),children:i.negative}),(0,a.jsx)("div",{className:"count-box neutral",onClick:()=>u("neutral"),children:i.neutral}),(0,a.jsx)("div",{className:"count-box positive",onClick:()=>u("positive"),children:i.positive})]})}},412:(e,t,n)=>{var s=n(43),r=n(950),a=n(475),i=n(216),c=n(579);const o={main:s.lazy((()=>Promise.all([n.e(96),n.e(792)]).then(n.bind(n,977)).then((e=>({default:e.MainApp}))))),topbar:s.lazy((()=>Promise.all([n.e(96),n.e(792)]).then(n.bind(n,310)).then((e=>({default:e.TopbarApp}))))),background:s.lazy((()=>Promise.all([n.e(96),n.e(792)]).then(n.bind(n,86)).then((e=>({default:e.BackgroundApp}))))),navbar:s.lazy((()=>Promise.all([n.e(96),n.e(792)]).then(n.bind(n,94)).then((e=>({default:e.NavBarApp})))))},l=()=>(0,c.jsx)("div",{children:"Loading application..."});window.initializeApp=(e,t)=>{const n=new URLSearchParams(window.location.search).get("type")||"main";console.log("[Index] Initializing app type:",n);const d=o[n];d?r.render((0,c.jsx)(s.StrictMode,{children:(0,c.jsx)(a.I9,{children:(0,c.jsx)(s.Suspense,{fallback:(0,c.jsx)(l,{}),children:(0,c.jsx)(i.BV,{children:(0,c.jsx)(i.qh,{path:"/",element:(0,c.jsx)(d,{zafClient:e,originalQueryString:t})})})})})}),document.getElementById("root")):console.error("[Index] Unknown app type:",n)}},304:(e,t,n)=>{n.d(t,{DF:()=>p,PT:()=>g,YB:()=>m,aM:()=>v,cY:()=>h,pB:()=>u,tp:()=>l,zH:()=>d});var s=n(880),r=n(341);const a="https://api.silverstream.io/sentiment-checker",i=!1;let c="";async function o(e,t,n,r){const i=(await e.context()).account.subdomain;h(`Making API request to ${a}${t}`,{method:n,subdomain:i,body:r});h("Session token in cookie:",s.A.get("session_token"));const o=new URL(`${a}${t}`),l=new URLSearchParams(c);l.set("subdomain",i),o.search=l.toString(),h(`Trying to fetch ${o.toString()} with method ${n}`);try{const e=await fetch(o.toString(),{method:n,headers:{"Content-Type":"application/json","X-Zendesk-Subdomain":i},body:JSON.stringify(r),credentials:"include"});if(!e.ok){const t=await e.text();throw g(`API request failed: ${e.status} ${e.statusText}`,t),new Error(`API request failed: ${e.status} ${e.statusText}`)}const t=await e.json();return h(`API response from ${o.toString()}:`,t),t}catch(d){throw h(`API request failed: ${d}`),d}}async function l(e,t){h("Listing ticket vectors for ticket:",t);const n=await o(e,"/get-ticket-vectors","POST",{tickets:[t]});return n.vectors&&"object"===typeof n.vectors?n.vectors[t]||[]:n.Error?(g("Error fetching vectors:",n.Error),[]):(g("Unexpected response from API:",n),[])}async function d(e,t,n){h("Analyzing comments for ticket:",t,n);const s={};n["ticket.comments"].forEach((e=>{s[e.id]={text:e.value,created_at:e.created_at||(new Date).toISOString()}})),await o(e,"/analyze-comments","POST",{tickets:{[t]:{comments:s}}})}async function u(e,t){let n;h("Getting score for tickets:",t),n=Array.isArray(t)?t:"object"===typeof t&&"ticketId"in t?[t.ticketId]:[t];const s=await o(e,"/get-score","POST",{tickets:n});return h("Score data:",s.score),s.score}function h(){if(i){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.log("[DEBUG]",...t)}}function g(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.error("[ERROR]",...t)}async function m(e){const t=new Date;t.setDate(t.getDate()-30);const n=(await e.get("ticket")).ticket.requester.id,s=(await e.request({url:"/api/v2/search.json",type:"GET",data:{query:`type:ticket created>${t.toISOString()} requester:${n}`}})).results.map((e=>e.id));return 0===s.length?(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.warn("[WARN]",...t)}("No ticket IDs found for last 30 days"),r.au):(h("Ticket IDs for last 30 days:",s),await u(e,s))}async function p(e,t){h("Updating ticket sentiment:",t);try{const n=await e.request({url:`/api/v2/tickets/${t.id}.json`,type:"GET"}),s={...t,requestor:n.ticket.requester?{id:n.ticket.requester.id,name:n.ticket.requester.name}:void 0,assignee:n.ticket.assignee?{id:n.ticket.assignee.id,name:n.ticket.assignee.name}:void 0};await o(e,"/analyze-comments","POST",{ticket:s})}catch(n){throw g("Error updating ticket sentiment:",n),n}}async function v(e){h("Getting unsolved tickets from cache");try{const t=await o(e,"/get-unsolved-tickets","POST");return h("Cache response:",t),{results:Array.isArray(null===t||void 0===t?void 0:t.results)?t.results:[]}}catch(t){return g("Error getting unsolved tickets:",t),{results:[]}}}},341:(e,t,n)=>{n.d(t,{FD:()=>a,au:()=>s,bv:()=>r});const s=0,r=-1,a=1}},e=>{e.O(0,[96],(()=>{return t=412,e(e.s=t);var t}));e.O()}]);
//# sourceMappingURL=main.js.map